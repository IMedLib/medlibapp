<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>注册</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/login.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <form class="form-signin">
        <h3 class="form-signin-heading" style="text-align: center;">注册</h3>
        <input type="text" id="mobile" name="mobile"
               class="form-control" placeholder="手机号码" required autofocus>
        <input type="text" id="recuid" placeholder="推荐人ID（选填）" class="form-control">
        <span id="mobileErr" style="color: red"></span>
        <input type="text" id="code" name="code"
               class="form-control" placeholder="验证码" required>
        <span id="codeErr" style="color: red"></span>
        <button class="btn btn-block btn-primary" id="codeGet" type="button">点击获取验证码</button>
        <button class="btn btn-lg btn-info btn-block" type="submit" id="register">注册</button>
        <span id="registerErr" style="color: red"></span>
    </form>
</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var wait = 60, url = "http://121.41.92.56:8002/";
        $('form').submit(function () {
            var mobile = $('#mobile').val();
            var code = $('#code').val();
            if (!isMobile(mobile)) {
                $('#mobileErr').text('非法手机号码！').fadeOut(5000);
                return false;
            }
            if (code.length != 6) {
                $('#codeErr').text('验证码错误！').fadeOut(5000);
            }
            $.getJSON(url + 'User/Add/Reg/', {
                mobile: mobile,
                recuid:$('#recuid').val(),
                verifycode: code
            }).done(function (data) {
                if (data.code != 0) {
                    $('#registerErr').text(data.msg == "" ? "注册失败，请重新尝试！" : data.msg)
                            .fadeOut(5000);
                    return false;
                }
                if (data.token != '' && data.key != '') {
                    var end = (new Date).getDate() + 7;
                    setCookie('key', data.key, end);
                    setCookie('token', data.token, end);
                    window.location.href = '/';
                }
            }).fail(function () {
                $('#registerErr').text("请求超时！").fadeOut(5000);
            });
            return false;
        });
        $('#codeGet').on('click', function () {
            var mobile=$('#mobile').val();
            if (!isMobile(mobile)) {
                $('#mobileErr').text('非法手机号码！').fadeOut(5000);
                return false;
            }
            setTime($(this));
            getCode(mobile);
        });
        function isMobile(mobile){
            if(mobile.length == 11 && /^(((13)|(15)|(17)|(18))+\d{9})$/.test(mobile))
                return true;
            return false;
        }
        function getCode(mobile) {
            $.getJSON(url + '/Captcha/Add', {
                mobile
            }).done(function(data){
                if (data.code != 0) {
                    $('#codeErr').text(data.msg == "" ? "获取失败，请重新尝试！" : data.msg)
                            .fadeOut(5000);
                    return false;
                }
                $('#code').val(data.verifycode);
            }).fail(function () {
                $('#codeErr').text("请求超时！").fadeOut(5000);
            });
        }

        function setTime(object) {
            if (wait == 0) {
                object.removeAttr('disabled');
                object.text("点击获取验证码");
                wait = 60;
            } else {
                object.attr('disabled', true);
                object.text("重新发送(" + wait + ")");
                wait--;
                setTimeout(function () {
                    setTime(object);
                }, 1000);
            }
        }

        function setCookie(sKey, sValue, vEnd, sPath, sDomain, bSecure) {
            if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) {
                return false;
            }
            var sExpires = "";
            if (vEnd) {
                switch (vEnd.constructor) {
                    case Number:
                        sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
                        break;
                    case String:
                        sExpires = "; expires=" + vEnd;
                        break;
                    case Date:
                        sExpires = "; expires=" + vEnd.toUTCString();
                        break;
                }
            }
            document.cookie = encodeURIComponent(sKey) + "=" + encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
            return true;
        }
    });
</script>
</body>
</html>